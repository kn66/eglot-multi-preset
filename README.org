#+TITLE: eglot-multi-preset
#+AUTHOR: kn66

Multi-server LSP preset selection for Eglot.

* Overview

=eglot-multi-preset= provides a mechanism for selecting LSP server presets when starting Eglot. This is particularly useful when working with LSP multiplexers like [[https://github.com/AshleyYakeley/rassumfrassum][rass (rassumfrassum)]] where different projects may require different server combinations.

*Important:* This package is designed for *multi-server configurations only*. Single-server setups should use =eglot-server-programs= directly.

* Features

- Interactive preset selection via =completing-read= when starting Eglot
- Automatic persistence of selected presets to =.dir-locals.el=
- Support for per-project preset configuration
- Force re-selection with =C-u M-x eglot=
- Programmatic API for registering custom presets
- Mode inheritance support (e.g., =python-ts-mode= inherits from =python-mode=)
- Language ID overrides for modes that need explicit LSP IDs (e.g. =tsx-ts-mode=)

* Requirements

- Emacs 30.1 or later
- Eglot 1.20 or later

* Installation

** Install rass

Install rassumfrassum first so the =rass= command is available:

#+begin_src sh
  pip install rassumfrassum
#+end_src

** Manual Installation

Clone or download this repository, then add to your =load-path=:

#+begin_src emacs-lisp
  (add-to-list 'load-path "/path/to/eglot-multi-preset")
  (require 'eglot-multi-preset)
#+end_src

** With use-package

#+begin_src emacs-lisp
  (use-package eglot-multi-preset
    :vc ( :url "https://github.com/kn66/eglot-multi-preset.git"
          :rev :newest)
    :config
    (eglot-multi-preset-mode 1))
#+end_src

* Quick Start

1. Enable the mode:

   #+begin_src emacs-lisp
     (eglot-multi-preset-mode 1)
   #+end_src

2. Open a Python or TypeScript file and run =M-x eglot=

3. Select a preset from the completion menu:
   - "eglot default" uses the standard =eglot-server-programs=
   - Other options are multi-server presets (e.g., "rass: ty + ruff")

4. When prompted, choose whether to save the selection to =.dir-locals.el=

5. Next time you run =M-x eglot= in the same project, the saved preset is used automatically

6. To force preset re-selection: =C-u M-x eglot=

* Configuration

** =eglot-multi-preset-alist=

Alist mapping major modes to their LSP server presets. Each entry is =(MODE-OR-MODES . PRESETS)= where:

- =MODE-OR-MODES= is a single mode symbol or list of mode symbols
- =PRESETS= is a list of =(PRESET-NAME . CONTACT)= pairs

#+begin_src emacs-lisp
  (setq eglot-multi-preset-alist
        '(((python-mode python-ts-mode)
           . (("rass: ty + ruff" . ("rass" "python"))
              ("rass: pyright + ruff" . ("rass" "--" "pyright-langserver" "--stdio"
                                         "--" "ruff" "server"))
              ("rass: pyright + ty + ruff" . ("rass" "--" "pyright-langserver" "--stdio"
                                              "--" "ty" "server"
                                              "--" "ruff" "server"))))
          ((typescript-mode typescript-ts-mode)
           . (("rass: ts-ls + eslint"
               . ("rass" "--" "typescript-language-server" "--stdio"
                  "--" "vscode-eslint-language-server" "--stdio"))))))
#+end_src

** =eglot-multi-preset-auto-save=

Controls automatic saving of selected presets to =.dir-locals.el=:

- =ask= (default): Prompt before saving
- =always=: Save without prompting
- =never=: Never save

#+begin_src emacs-lisp
  (setq eglot-multi-preset-auto-save 'always)
#+end_src

** =eglot-multi-preset-dir-locals-directory=

Directory where =.dir-locals.el= should be saved. If =nil= (default), uses the project root.

#+begin_src emacs-lisp
  (setq eglot-multi-preset-dir-locals-directory "/path/to/config/dir")
#+end_src

*Note:* Saving presets rewrites =.dir-locals.el= as a normalized Lisp form.
Existing comments or hand formatting in that file may be lost after save.
If the file contains malformed content, or additional non-comment forms after
the main top-level form, saving is refused to avoid destructive overwrites.

** =eglot-multi-preset-language-id-overrides=

Override LSP =languageId= per mode when needed:

#+begin_src emacs-lisp
  (setq eglot-multi-preset-language-id-overrides
        '((tsx-ts-mode . "typescriptreact")
          (typescript-ts-mode . "typescript")))
#+end_src

** =eglot-multi-preset-executable-overrides=

Override executable names used by built-in presets.  Useful on Windows
when your environment provides =rass.exe= instead of =rass.cmd=.

#+begin_src emacs-lisp
  (setq eglot-multi-preset-executable-overrides
        '(("rass" . "rass.exe")))
#+end_src

If you change this after the package is already loaded, regenerate the
built-in preset contacts:

#+begin_src emacs-lisp
  (eglot-multi-preset-reset-default-presets)
#+end_src

*Tip:* if you use =setopt= (or Customize), built-ins are rebuilt automatically.

** =eglot-multi-preset-extra-tcp-hosts=

Treat additional single-label hostnames as TCP contacts for two-item contacts
of the form =(HOST PORT)=.
This is useful for hosts like =devbox= that are not FQDNs.

#+begin_src emacs-lisp
  (setq eglot-multi-preset-extra-tcp-hosts '("devbox" "staging-lsp"))
#+end_src

** =eglot-multi-preset-extra-alist=

Add custom presets while keeping built-in defaults.
This is merged into the built-ins, and when preset names collide your
custom entry takes precedence.

#+begin_src emacs-lisp
  (setq eglot-multi-preset-extra-alist
        '((python-mode
           . (("rass: pyright + ty + ruff (strict)"
               . ("rass" "--" "pyright-langserver" "--stdio"
                  "--" "ty" "server"
                  "--" "ruff" "server"))))))
#+end_src

If you change this after package load and want to rebuild immediately:

#+begin_src emacs-lisp
  (eglot-multi-preset-reset-default-presets)
#+end_src

** =eglot-multi-preset-eslint-workspace-config=

Override the workspace/configuration payload used for ESLint presets:

#+begin_src emacs-lisp
  (setq eglot-multi-preset-eslint-workspace-config
        '(:eslint (:validate "probe"
                   :workingDirectory (:mode "auto")
                   :workingDirectories [(:mode "auto")]
                   :packageManager "pnpm")))
#+end_src

** =eglot-multi-preset-tailwind-workspace-config=

Override the workspace/configuration payload used for Tailwind presets:

#+begin_src emacs-lisp
  (setq eglot-multi-preset-tailwind-workspace-config
        '(:tailwindCSS (:emmetCompletions :json-false
                        :showPixelEquivalents t
                        :rootFontSize 16
                        :validate t
                        :hovers t
                        :suggestions t
                        :codeActions t
                        :classAttributes ["class" "className"])))
#+end_src

** =eglot-multi-preset-tailwind-initialization-options=

Override initialization options passed to =tailwindcss-language-server=
for Tailwind presets:

#+begin_src emacs-lisp
  (setq eglot-multi-preset-tailwind-initialization-options
        '(:configuration (:tailwindCSS (:validate t :suggestions t))))
#+end_src

After changing any of the three settings above, regenerate built-in presets:

#+begin_src emacs-lisp
  (eglot-multi-preset-reset-default-presets)
#+end_src

*Tip:* if you use =setopt= (or Customize), built-ins are rebuilt automatically.

* Windows Support

On Windows, Node.js CLI tools installed via npm are provided as =.cmd= batch files (e.g., =rass.cmd=, =typescript-language-server.cmd=). This package automatically detects Windows and appends the =.cmd= suffix to executable names in the default presets.

If you register custom presets with =eglot-multi-preset-register=, you may need to handle platform-specific executable names yourself:

#+begin_src emacs-lisp
  ;; Use the built-in helper for cross-platform compatibility
  (eglot-multi-preset-register 'vue-mode "rass: vue"
    `(,(eglot-multi-preset--executable-name "rass")
      "--" ,(eglot-multi-preset--executable-name "vue-language-server") "--stdio"))
#+end_src

* Default Presets

The package includes these default presets:

** Python

| Preset               | Servers                                      |
|----------------------+----------------------------------------------|
| rass: ty + ruff      | ty (type checker) + ruff (linter/formatter)  |
| rass: pyright + ruff | pyright-langserver + ruff server             |
| rass: pyright + ty + ruff | pyright-langserver + ty server + ruff server |

** TypeScript/JavaScript

| Preset                          | Servers                                            |
|---------------------------------+----------------------------------------------------|
| rass: ts-ls + eslint            | typescript-language-server + eslint                |
| rass: ts-ls + eslint + tailwind | typescript-language-server + eslint + tailwindcss  |

* Troubleshooting

** ESLint diagnostics not shown

When using multi-server setups, some ESLint language server versions request
=workspace/configuration= with an empty =section= string.

=eglot-multi-preset= now includes an empty-section alias in workspace
configuration, and for ESLint configs it returns the =:eslint= subsection
(instead of the full plist) so this request resolves correctly.  The default
ESLint workspace config includes:

#+begin_src emacs-lisp
  (:eslint (:validate "probe"
             :workingDirectory (:mode "auto")
             :workingDirectories [(:mode "auto")]
             :packageManager "npm"))
#+end_src

** Tailwind completion not shown

Tailwind presets now send non-null =initializationOptions.configuration=
compatible with =lsp-tailwindcss= defaults.

If logs still contain =No matching project for document=, the Tailwind project
was not detected by =tailwindcss-language-server=.  A common cause is mixing
Tailwind v4 package versions with v3-style CSS entrypoints
(=@tailwind base;=, =@tailwind components;=, =@tailwind utilities;=).

Make sure your Tailwind setup is version-consistent (v3 config/style or v4
config/style), then restart Eglot.

* Custom Preset API

** =eglot-multi-preset-register=

Register a new preset for a mode:

#+begin_src emacs-lisp
  (eglot-multi-preset-register 'vue-mode "rass: vue + tailwind"
                               '("rass" "--" "vue-language-server" "--stdio"
                                 "--" "tailwindcss-language-server" "--stdio"))
#+end_src

You can also pass =workspace-config= as the 4th argument:

#+begin_src emacs-lisp
  (eglot-multi-preset-register
   'typescript-mode
   "rass: ts-ls + eslint (custom ws)"
   '("rass" "--" "typescript-language-server" "--stdio"
     "--" "vscode-eslint-language-server" "--stdio")
   '(:eslint (:validate "probe"
              :workingDirectory (:mode "auto"))))
#+end_src

** =eglot-multi-preset-unregister=

Remove a preset:

#+begin_src emacs-lisp
  (eglot-multi-preset-unregister 'vue-mode "rass: vue + tailwind")
#+end_src

** =eglot-multi-preset-clear-dir-locals=

Interactively remove saved eglot configuration from =.dir-locals.el= for
the current mode and related modes in the same preset group:

#+begin_src emacs-lisp
  M-x eglot-multi-preset-clear-dir-locals
#+end_src

* Testing

Run ERT tests from the project root:

#+begin_src shell
  emacs -Q --batch --eval '(setq load-prefer-newer t)' -L . \
    -l tests/eglot-multi-preset-tests.el \
    -f ert-run-tests-batch-and-exit
#+end_src

* Related Packages

- [[https://github.com/joaotavora/eglot][Eglot]] - The Emacs LSP client this package extends
- [[https://github.com/joaotavora/rassumfrassum][rass (rassumfrassum)]] - LSP multiplexer for combining multiple language servers

* License

This package is distributed under the MIT License. See the [[file:LICENSE][LICENSE]] file for details.
